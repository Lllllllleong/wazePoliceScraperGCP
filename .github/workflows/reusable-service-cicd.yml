name: Reusable Service CI/CD

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      go-version:
        required: false
        type: string
        default: '1.24'
      min-coverage:
        required: false
        type: number
        default: 20
    secrets:
      CODECOV_TOKEN:
        required: false

env:
  GCP_PROJECT_ID: "wazepolicescrapergcp"
  GAR_LOCATION: "us-central1"
  REGION: "us-central1"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}

      - name: Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m ./cmd/${{ inputs.service-name }}/...

      - name: Test
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./cmd/${{ inputs.service-name }}/...
          go tool cover -func=coverage.out

      - name: Coverage check
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < ${{ inputs.min-coverage }}" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE}% below threshold ${{ inputs.min-coverage }}%"
            exit 1
          fi

      - uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: ${{ inputs.service-name }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.service-name }}-coverage
          path: coverage.out
          retention-days: 30

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/807773831037/locations/global/workloadIdentityPools/github/providers/my-repo
          service_account: github-actions-runner@wazepolicescrapergcp.iam.gserviceaccount.com
          token_format: access_token

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      - uses: docker/setup-buildx-action@v3

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          push: true
          tags: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ inputs.service-name }}/${{ inputs.service-name }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ inputs.service-name }}
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ inputs.service-name }}/${{ inputs.service-name }}:${{ github.sha }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - run: echo "Deployed to ${{ steps.deploy.outputs.url }}"
