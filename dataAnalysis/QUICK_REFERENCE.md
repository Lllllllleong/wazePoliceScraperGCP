# Time Range Filter - Quick Reference

## New UI Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“… Step 1: Select Dates to Load                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [Click to select dates...] (Flatpickr)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  âœ“ 3 days selected                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ”„ Reset Dashboardâ”‚  â”‚ ğŸ“¥ Load Data             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â³ Loading day 2 of 3: 2025-10-04...                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” Step 2: Alert Filters (DISABLED until data loaded) â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Subtype: [All Types â–¼]                           â”‚ â”‚
â”‚  â”‚ City: [All Cities â–¼]                              â”‚ â”‚
â”‚  â”‚ Min Reliability: [â”â”â”â”â—‹â”â”â”â”â”] 0                   â”‚ â”‚
â”‚  â”‚ Min Thumbs Up: [0]                                â”‚ â”‚
â”‚  â”‚ [Apply Filters]  [Reset Filters]                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Loading Process

```
User selects dates: [Oct 3] [Oct 4] [Oct 6]
                     â†“
Chronologically sorted: Oct 3 â†’ Oct 4 â†’ Oct 6
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ For each date:                          â”‚
â”‚                                         â”‚
â”‚ Day Oct 3:                              â”‚
â”‚   Query: publish_time <= 23:59:59       â”‚
â”‚          expire_time >= 00:00:00        â”‚
â”‚   Results: Alert A, Alert B             â”‚
â”‚   Map: {uuid-A: Alert A, uuid-B: B}     â”‚
â”‚                                         â”‚
â”‚ Day Oct 4:                              â”‚
â”‚   Query: publish_time <= 23:59:59       â”‚
â”‚          expire_time >= 00:00:00        â”‚
â”‚   Results: Alert B, Alert C             â”‚
â”‚   Map: {uuid-A: A, uuid-B: B, uuid-C: C}â”‚
â”‚         (Alert B skipped - duplicate!)  â”‚
â”‚                                         â”‚
â”‚ Day Oct 6:                              â”‚
â”‚   Query: publish_time <= 23:59:59       â”‚
â”‚          expire_time >= 00:00:00        â”‚
â”‚   Results: Alert D                      â”‚
â”‚   Map: {..., uuid-D: Alert D}           â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
Final allAlerts = [Alert A, Alert B, Alert C, Alert D]
                     â†“
Enable Stage 2 Filters â†’ User can now filter/view
```

## Button Behavior

### ğŸ”„ Reset Dashboard/Data
- Clears `allAlerts` and `alertsMap`
- Clears date picker selection
- Disables Stage 2 filters
- Clears map markers
- Resets all statistics to "-"
- Shows welcome message

### ğŸ“¥ Load Data
- Only enabled when dates selected
- Shows loading spinner
- Queries Firestore for each selected date
- Updates progress message
- Enables Stage 2 on success
- Populates city filter dropdown

### Apply Filters (Stage 2)
- Filters already-loaded data
- Does NOT query Firestore
- Updates map, list, statistics

### Reset Filters (Stage 2)
- Resets filter controls to defaults
- Keeps loaded data
- Re-applies filters (showing all loaded data)

## Key Code Changes

### Global State
```javascript
// OLD
let allAlerts = [];

// NEW
let allAlerts = [];           // Array of alerts
let alertsMap = new Map();    // UUID -> alert (deduplication)
let selectedDates = [];       // User-selected dates
let flatpickrInstance = null; // Date picker instance
```

### Function Mapping

| Old Function | New Function | Purpose |
|--------------|--------------|---------|
| `loadAlertsFromFirestore()` | `loadAlertsForSelectedDates()` | Load data |
| `setInitialDateRange()` | `initDatePicker()` | Setup date selection |
| N/A | `disableStage2UI()` | Lock filters |
| N/A | `enableStage2UI()` | Unlock filters |
| N/A | `resetDashboard()` | Full reset |
| `resetFilters()` | `resetFilters()` | Same (modified) |

## Date Picker Configuration

```javascript
flatpickr('#date-picker', {
  mode: 'multiple',              // Select multiple dates
  dateFormat: 'Y-m-d',           // 2025-10-03
  minDate: '2025-10-03',         // Hardcoded start
  maxDate: new Date(),           // Today
  inline: false,                 // Dropdown (not always visible)
  onChange: updateSelectedDatesDisplay
});
```

## Firestore Query Example

**Single Day Query:**
```javascript
const dayStart = new Date('2025-10-03T00:00:00');
const dayEnd = new Date('2025-10-03T23:59:59.999');

db.collection('police_alerts')
  .where('publish_time', '<=', dayEnd)
  .where('expire_time', '>=', dayStart)
  .get();
```

**What this captures:**
- Alert published on Oct 3 (any time) â†’ âœ…
- Alert published on Oct 2, expires Oct 3 â†’ âœ…
- Alert published on Oct 1, expires Oct 5 â†’ âœ…
- Alert published on Oct 5 â†’ âŒ
- Alert published on Oct 2, expires Oct 2 â†’ âŒ

## Testing Commands

Open browser console and test:

```javascript
// Check global state
console.log('Alerts loaded:', allAlerts.length);
console.log('Map size:', alertsMap.size);
console.log('Selected dates:', selectedDates);

// Manually trigger functions
resetDashboard();
enableStage2UI();
disableStage2UI();

// Check for duplicates
const uuids = allAlerts.map(a => a.UUID);
const duplicates = uuids.filter((u, i) => uuids.indexOf(u) !== i);
console.log('Duplicate UUIDs:', duplicates); // Should be []
```

## Common Issues & Solutions

### Issue: "Load Data" button stays disabled
**Solution**: Check that dates are selected in date picker

### Issue: Firestore index error
**Solution**: Click the link in console to create composite index

### Issue: No alerts loaded
**Possible causes**:
- Selected dates have no data
- Firestore rules prevent read access
- Not authenticated anonymously

### Issue: Stage 2 filters don't work
**Check**:
- Are they enabled? (opacity should be 1)
- Is data loaded? (check allAlerts.length)

### Issue: Seeing duplicate alerts
**Debug**:
```javascript
// Check map vs array length
console.log('Map:', alertsMap.size, 'Array:', allAlerts.length);
// They should match!
```

## Browser Compatibility

- âœ… Chrome/Edge (Chromium)
- âœ… Firefox
- âœ… Safari
- âœ… Mobile browsers

Flatpickr has excellent browser support.

## Performance Tips

1. **Don't select too many days at once**: Each day = 1 Firestore query
2. **Consecutive days are fine**: Deduplication handles overlaps efficiently
3. **Use Reset Filters instead of Reset Dashboard**: Keeps data in memory
4. **Consider caching**: Future improvement for frequently selected dates

---

**Need help?** Check `REFACTOR_SUMMARY.md` for detailed documentation.
